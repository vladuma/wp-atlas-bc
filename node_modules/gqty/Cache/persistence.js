'use strict';

Object.defineProperty(exports, '__esModule', { value: true });

const object = require('../Utils/object.js');
const cycle = require('../Utils/cycle.js');
require('lodash/mergeWith.js');

function createPersistenceHelpers(clientCache, selectionManager) {
  function backupPersistence(version) {
    const { query } = clientCache.cache;
    const cache = cycle.decycle({ query });
    const selections = selectionManager.backup();
    return JSON.stringify({
      version,
      cache,
      selections
    });
  }
  function restorePersistence(backup, expectedVersion) {
    if (typeof backup === "function") {
      return new Promise((resolve) => {
        backup().then((value) => resolve(restore(value))).catch(() => resolve(false));
      });
    }
    return restore(backup);
    function restore(backup2) {
      if (typeof backup2 !== "string")
        return false;
      const backupObject = JSON.parse(backup2);
      if (object.isPlainObject(backupObject) && object.isPlainObject(backupObject.cache)) {
        if (expectedVersion && !backupObject.version || backupObject.version && !expectedVersion) {
          return false;
        }
        if (expectedVersion && backupObject.version) {
          if (typeof backupObject.version === "string") {
            if (backupObject.version !== expectedVersion) {
              return false;
            }
          } else {
            return false;
          }
        }
        Object.assign(clientCache.cache, cycle.retrocycle(backupObject.cache));
        selectionManager.restore(backupObject.selections);
        return true;
      }
      return false;
    }
  }
  return {
    backupPersistence,
    restorePersistence
  };
}

exports.createPersistenceHelpers = createPersistenceHelpers;
